<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>vPricer - Compare Vehicle Prices Across Dealers</title>
    
    <!-- Production-ready Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        html { scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .spinner {
            border: 3px solid rgba(249, 115, 22, 0.3);
            border-top-color: #f97316;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-zinc-900 text-white min-h-screen">
    
    <div class="fixed inset-0 opacity-10 pointer-events-none" style="z-index: 0;">
        <div class="absolute inset-0" style="background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.03) 2px, rgba(255,255,255,0.03) 4px), repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255,255,255,0.03) 2px, rgba(255,255,255,0.03) 4px); background-size: 50px 50px;"></div>
    </div>

    <div class="relative" style="z-index: 10;">
        <header class="border-b border-zinc-700/50 backdrop-blur-sm bg-slate-900/50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex items-center gap-4">
                    <div class="flex items-center justify-center w-14 h-14 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl shadow-lg shadow-orange-500/30">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-black tracking-tight">V<span class="text-orange-500">PRICER</span></h1>
                        <p class="text-sm text-zinc-400 font-medium tracking-wide">FIND THE BEST DEAL ON YOUR NEXT RIDE</p>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="mb-12">
                <div class="bg-gradient-to-br from-slate-800/90 to-slate-900/90 backdrop-blur-md rounded-2xl border border-zinc-700/50 p-8 shadow-2xl">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-2 flex items-center gap-3">
                            <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            Start Your Search
                        </h2>
                        <p class="text-zinc-400">Enter a vehicle listing URL to find and compare prices at real OEM dealers within 100 miles</p>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="urlInput" placeholder="https://dealer.com/2026-subaru-crosstrek-premium" class="flex-1 px-6 py-4 bg-slate-900 border border-zinc-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent text-white placeholder-zinc-500 text-lg" onkeypress="if(event.key === 'Enter') handleSearch()"/>
                        <button id="searchBtn" onclick="handleSearch()" class="px-8 py-4 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 disabled:from-zinc-700 disabled:to-zinc-800 disabled:cursor-not-allowed rounded-xl font-bold text-white shadow-lg shadow-orange-500/30 transition-all duration-200 flex items-center justify-center gap-2 text-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="m3 3 3 9-3 9 19-9Z"></path></svg>
                            <span>Compare</span>
                        </button>
                    </div>

                    <div id="loadingStatus" class="mt-4 hidden p-4 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="spinner"></div>
                            <span class="text-orange-400" id="statusText">Initializing...</span>
                        </div>
                        <div id="progressContainer" class="space-y-2 hidden">
                            <div class="flex justify-between text-sm text-zinc-400">
                                <span>Progress</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="w-full bg-slate-800 rounded-full h-2.5 overflow-hidden">
                                <div id="progressFill" class="bg-gradient-to-r from-orange-500 to-red-600 h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-zinc-500 text-center" id="progressSubtext">Preparing search...</p>
                        </div>
                    </div>

                    <div id="errorMsg" class="mt-4 hidden p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400"></div>
                </div>
            </div>

            <div id="resultsContainer"></div>
        </main>
        
        <footer class="border-t border-zinc-700/50 mt-12 py-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-zinc-500 text-sm">
                <p>&copy; 2026 vPricer. Real dealer search with live data.</p>
            </div>
        </footer>
    </div>

    <script>
        // Configuration - UPDATE THIS WITH YOUR BACKEND URL
        const API_URL = '/api';  // Change to your backend URL, e.g., 'https://yourdomain.com/api'

        const appState = {
            sourceVehicle: null,
            discoveredDealers: [],
            selectedDealers: new Set(),
            comparisons: [],
            isLoading: false
        };

        // API call wrapper
        async function callAPI(endpoint, data) {
            try {
                const response = await fetch(API_URL + endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('API request failed: ' + response.status);
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        function showLoading(message, showProgress) {
            const loadingDiv = document.getElementById('loadingStatus');
            const statusText = document.getElementById('statusText');
            const progressContainer = document.getElementById('progressContainer');
            const searchBtn = document.getElementById('searchBtn');
            
            appState.isLoading = true;
            searchBtn.disabled = true;
            loadingDiv.classList.remove('hidden');
            statusText.textContent = message;
            
            if (showProgress) {
                progressContainer.classList.remove('hidden');
            } else {
                progressContainer.classList.add('hidden');
            }
        }

        function hideLoading() {
            document.getElementById('loadingStatus').classList.add('hidden');
            document.getElementById('searchBtn').disabled = false;
            appState.isLoading = false;
        }

        function updateProgress(percent, subtext) {
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressFill').style.width = percent + '%';
            if (subtext) {
                document.getElementById('progressSubtext').textContent = subtext;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(function() { errorDiv.classList.add('hidden'); }, 8000);
        }

        function clearError() {
            document.getElementById('errorMsg').classList.add('hidden');
        }

        async function handleSearch() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            
            if (!url) {
                showError('Please enter a vehicle listing URL');
                return;
            }
            
            if (!url.startsWith('http')) {
                showError('Please enter a valid URL starting with http:// or https://');
                return;
            }
            
            clearError();
            showLoading('Analyzing source listing...', true);
            updateProgress(10, 'Extracting vehicle information...');
            
            try {
                // Call backend to extract vehicle info
                const vehicleInfo = await callAPI('/extract-vehicle', { url: url });
                
                if (!vehicleInfo || !vehicleInfo.year || !vehicleInfo.make || !vehicleInfo.model) {
                    throw new Error('Could not extract vehicle information from URL');
                }
                
                updateProgress(40, 'Vehicle details extracted...');
                
                if (!vehicleInfo.state || !vehicleInfo.city) {
                    throw new Error('Could not determine location from listing');
                }
                
                appState.sourceVehicle = vehicleInfo;
                appState.sourceVehicle.url = url;
                
                updateProgress(60, 'Finding real ' + vehicleInfo.make + ' dealers near ' + vehicleInfo.city + '...');
                
                // Call backend to discover dealers
                const dealers = await callAPI('/discover-dealers', {
                    state: vehicleInfo.state,
                    city: vehicleInfo.city,
                    make: vehicleInfo.make
                });
                
                if (!dealers || dealers.length === 0) {
                    hideLoading();
                    showError('No verified ' + vehicleInfo.make + ' dealerships found near ' + vehicleInfo.city + ', ' + vehicleInfo.state);
                    return;
                }
                
                appState.discoveredDealers = dealers;
                
                updateProgress(100, 'Found ' + dealers.length + ' verified dealers!');
                
                setTimeout(function() {
                    hideLoading();
                    displaySourceVehicle();
                    displayDealerSelection();
                    document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 500);
                
            } catch (error) {
                hideLoading();
                showError('Error: ' + error.message + '. Please check your backend is running and configured correctly.');
                console.error(error);
            }
        }

        function displaySourceVehicle() {
            const v = appState.sourceVehicle;
            const html = '<div class="mb-8 animate-fade-in"><h3 class="text-xl font-bold mb-4 flex items-center gap-2"><div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>Your Selected Vehicle</h3><div class="bg-gradient-to-br from-orange-500/20 to-red-600/20 backdrop-blur-md rounded-xl border-2 border-orange-500/50 p-6 shadow-xl"><div class="flex flex-wrap items-center gap-6"><div class="flex-1 min-w-[250px]"><h4 class="text-2xl font-black mb-2">' + v.year + ' ' + v.make + ' ' + v.model + ' <span class="text-orange-400">(' + v.trim + ')</span></h4><p class="text-zinc-300 mb-1">' + (v.dealerName || 'Source Dealer') + '</p><p class="text-zinc-400 text-sm mb-2">' + v.location + '</p>' + (v.mileage ? '<p class="text-zinc-400 text-sm mb-2">' + v.mileage + ' miles</p>' : '') + (v.originalPrice ? '<p class="text-zinc-400 text-sm mb-1"><span class="line-through">MSRP: ' + v.originalPrice + '</span></p>' : '') + (v.discount ? '<p class="text-green-400 text-sm font-bold mb-1">ðŸ’° Save ' + v.discount + '</p>' : '') + '<p class="text-3xl font-black text-orange-400">' + v.price + '</p></div><a href="' + v.url + '" target="_blank" class="px-6 py-3 bg-white text-slate-900 rounded-lg font-bold hover:bg-zinc-200 transition-colors flex items-center gap-2">View Original<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="m10 14 11-11"></path></svg></a></div></div></div>';
            document.getElementById('resultsContainer').innerHTML = html;
        }

        function displayDealerSelection() {
            const dealers = appState.discoveredDealers;
            const v = appState.sourceVehicle;
            
            let dealersHTML = dealers.map(function(d, i) {
                const isSelected = appState.selectedDealers.has(i);
                return '<div onclick="toggleDealer(' + i + ')" class="p-5 rounded-xl border-2 transition-all cursor-pointer ' + (isSelected ? 'bg-orange-500/20 border-orange-500' : 'bg-slate-800/50 border-zinc-700 hover:border-zinc-600') + '"><div class="flex items-start gap-4"><div class="flex-shrink-0 w-6 h-6 rounded border-2 mt-1 transition-all ' + (isSelected ? 'bg-orange-500 border-orange-500' : 'border-zinc-600') + '">' + (isSelected ? '<svg class="w-full h-full text-white p-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>' : '') + '</div><div class="flex-1"><h4 class="text-lg font-bold mb-1">' + d.name + '</h4><p class="text-zinc-400 text-sm mb-1">âœ… Verified ' + v.make + ' Dealer</p><p class="text-zinc-400 text-sm mb-1">' + d.address + '</p><div class="flex flex-wrap gap-4 text-sm text-zinc-500 mt-2"><span>ðŸ“ ' + d.distance + '</span><span>ðŸ“ž ' + d.phone + '</span></div></div></div></div>';
            }).join('');

            const html = '<div class="mb-8 animate-fade-in"><div class="bg-gradient-to-br from-slate-800/90 to-slate-900/90 backdrop-blur-md rounded-2xl border border-zinc-700/50 p-8 shadow-2xl"><div class="mb-6"><div class="flex items-center justify-between mb-4"><h3 class="text-2xl font-bold flex items-center gap-3"><svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>Verified Dealers Near ' + v.city + '</h3><span class="px-4 py-2 bg-orange-500/20 border border-orange-500/30 rounded-lg font-bold text-orange-400">' + dealers.length + ' Found</span></div><p class="text-zinc-400 mb-2">âœ… Real authorized ' + v.make + ' dealerships with verified addresses</p><p class="text-zinc-400 mb-4">Select dealers to compare (within 100 miles):</p></div><div class="space-y-4 mb-6 max-h-[500px] overflow-y-auto pr-2">' + dealersHTML + '</div><div class="flex flex-col sm:flex-row gap-4"><button onclick="selectAllDealers()" class="px-6 py-3 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded-lg font-bold transition-colors">Select All</button><button onclick="clearAllDealers()" class="px-6 py-3 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 rounded-lg font-bold transition-colors">Clear All</button><button onclick="compareSelected()" class="flex-1 px-6 py-3 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 disabled:from-zinc-700 disabled:to-zinc-800 disabled:cursor-not-allowed rounded-lg font-bold text-white shadow-lg shadow-orange-500/30 transition-all flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="m3 3 3 9-3 9 19-9Z"></path></svg>Compare Selected (' + appState.selectedDealers.size + ')</button></div></div></div>';
            
            document.getElementById('resultsContainer').innerHTML += html;
        }

        function toggleDealer(index) {
            if (appState.selectedDealers.has(index)) {
                appState.selectedDealers.delete(index);
            } else {
                appState.selectedDealers.add(index);
            }
            displaySourceVehicle();
            displayDealerSelection();
        }

        function selectAllDealers() {
            appState.selectedDealers.clear();
            for (let i = 0; i < appState.discoveredDealers.length; i++) {
                appState.selectedDealers.add(i);
            }
            displaySourceVehicle();
            displayDealerSelection();
        }

        function clearAllDealers() {
            appState.selectedDealers.clear();
            displaySourceVehicle();
            displayDealerSelection();
        }

        async function compareSelected() {
            if (appState.selectedDealers.size === 0) {
                showError('Please select at least one dealer to compare.');
                return;
            }

            showLoading('Searching dealer inventories...', true);
            updateProgress(20, 'Querying ' + appState.selectedDealers.size + ' dealers...');
            
            try {
                const selectedIndices = Array.from(appState.selectedDealers);
                const selectedDealers = selectedIndices.map(function(i) { return appState.discoveredDealers[i]; });
                
                updateProgress(40, 'Searching real inventory systems...');
                
                // Call backend to search dealers
                const results = await callAPI('/search-dealers', {
                    year: appState.sourceVehicle.year,
                    make: appState.sourceVehicle.make,
                    model: appState.sourceVehicle.model,
                    trim: appState.sourceVehicle.trim,
                    dealers: selectedDealers
                });
                
                updateProgress(80, 'Processing results...');
                
                appState.comparisons = results || [];
                
                updateProgress(100, 'Found ' + appState.comparisons.length + ' exact matches!');
                
                setTimeout(function() {
                    hideLoading();
                    displayComparisons();
                    setTimeout(function() {
                        const el = document.querySelector('#resultsContainer > div:last-child');
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }, 500);
                
            } catch (error) {
                hideLoading();
                showError('Error comparing dealers: ' + error.message);
                console.error(error);
            }
        }

        function displayComparisons() {
            const comparisons = appState.comparisons;
            
            if (comparisons.length === 0) {
                const html = '<div class="mb-8 animate-fade-in"><div class="bg-gradient-to-br from-slate-800/90 to-slate-900/90 backdrop-blur-md rounded-2xl border border-zinc-700/50 p-8 shadow-2xl text-center"><div class="inline-flex items-center justify-center w-16 h-16 bg-orange-500/20 rounded-full mb-4"><svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg></div><h3 class="text-2xl font-bold mb-2">No Exact Matches Found</h3><p class="text-zinc-400">No dealers have the exact vehicle in inventory. Try selecting different dealers.</p></div></div>';
                document.getElementById('resultsContainer').innerHTML += html;
                return;
            }
            
            const cardsHTML = comparisons.map(function(v, i) {
                return '<div class="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-md rounded-xl border border-zinc-700/50 p-6 hover:border-orange-500/50 transition-all duration-300 group" style="animation: fadeIn 0.5s ease-out ' + (0.1 * i) + 's both;"><div class="mb-4"><h4 class="text-xl font-bold mb-2 group-hover:text-orange-400 transition-colors">' + v.year + ' ' + v.make + ' ' + v.model + ' <span class="text-orange-400">(' + v.trim + ')</span></h4><p class="text-zinc-400 text-sm mb-1">ðŸ“ ' + v.dealerName + '</p><p class="text-zinc-500 text-sm ml-6 mb-1">' + v.dealerAddress + '</p><p class="text-zinc-500 text-sm ml-6 mb-2 font-semibold text-orange-400">' + v.distance + ' away</p><p class="text-zinc-500 text-sm ml-6">ðŸ“ž ' + v.dealerPhone + '</p>' + (v.mileage ? '<p class="text-zinc-500 text-sm mt-2">ðŸš— ' + v.mileage + ' miles</p>' : '') + '</div><div class="border-t border-zinc-700/50 pt-4 mb-4">' + (v.originalPrice ? '<div class="mb-2"><span class="text-zinc-500 text-sm line-through">MSRP: ' + v.originalPrice + '</span></div>' : '') + (v.discount ? '<div class="mb-2 px-3 py-1 bg-green-500/20 border border-green-500/30 rounded-lg inline-block"><span class="text-green-400 text-sm font-bold">ðŸ’° Save ' + v.discount + '</span></div>' : '') + '<div class="flex items-center justify-between"><span class="text-zinc-400 text-sm font-medium">' + (v.discount ? 'Sale Price' : 'Price') + '</span><span class="text-2xl font-black text-orange-400">' + v.price + '</span></div></div><div class="flex gap-2"><a href="' + v.url + '" target="_blank" class="flex-1 px-4 py-3 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 hover:border-orange-500/50 rounded-lg font-bold text-center transition-all flex items-center justify-center gap-2">View Details<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="m10 14 11-11"></path></svg></a><a href="https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(v.dealerAddress) + '" target="_blank" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold transition-all flex items-center justify-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>Navigate</a></div></div>';
            }).join('');
            
            const html = '<div class="animate-fade-in"><div class="flex items-center justify-between mb-6"><h3 class="text-2xl font-bold flex items-center gap-3"><svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="m3 3 3 9-3 9 19-9Z"></path></svg>Exact Matches Found</h3><span class="px-4 py-2 bg-orange-500/20 border border-orange-500/30 rounded-lg font-bold text-orange-400">' + comparisons.length + ' Results</span></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">' + cardsHTML + '</div></div>';
            
            document.getElementById('resultsContainer').innerHTML += html;
        }
    </script>
</body>
</html>
